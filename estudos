;Projeto de Sistemas Embarcados - FIS01237
;Instituto de Fisica - UFRGS
;Prof. Milton A Tumelero
;
;Atividade 5a: Uso de ADC - Controlar intensidade de um LED com um potenciometro.
;
;Nesta atividade, um LED � conectado na porta D6, a sua intensidade ser� controlada pelo duty cycle de um PWM regulado por um potenciometro.
;O potenciomentro ser� conectado a porta ADC5.

.include m328Pdef.inc
.org 0x0000

;configurando o stacker pointer
inicio:
ldi    R16,low(RAMEND)  ;configura SPL como final da memoria RAM
out    SPL,R16
ldi    R16,high(RAMEND)  ;configura SPH como final da memoria RAM
out    SPH,R16

config_pin:
clr R16
out DDRC, R16
out PORTC, R16
ser R16
out DDRD, R16

config_adc:
ldi R16,0b01100101; AVcc, right adjusted, channel 0
sts ADMUX,R16
ldi R16,0b11000101 ; Enable, no-interrupt, prescaling: 1:32
sts ADCSRA,R16
ldi R16,0x00 ; Free running
sts ADCSRB,R16
ldi R16, 0b00_10000
sts    DIDR0,R16

config_timer:
ldi    R16,0b00_00_00_00
sts    TCCR2A,R16            ;Configura modo normal
ldi    R16,0b00_0_00_011
sts    TCCR2B,R16            ;Configura clk com prescaler de 64
ldi    R16,0xFA
sts    OCR2A,R16             ;Ajusta T/C2 em 1 ms
mov    R20,R16

config_pwm:
ldi R16, 0b10000011 ;configure TCCR0A to Fast PWM with COM0A1 to clear
out TCCR0A,R16
ldi R16, 0b00000100 ;configure TCCR0B to 1:1 prescaler
out TCCR0B,R16
ldi R16,0x80 ;configure duty cycle to 6/256
out OCR0A,R16

meas:
lds R16, ADCSRA
sbrc R16, ADSC
rjmp meas
lds R17, ADCH

light:
out    OCR0A,R17      ;Atualiza PWM com o valor de ADC
clr    R16
sts    TCNT2,R16      ;limpa TC2

wait:
lds      R16,TCNT2
cp R20, R16
brmi reset_adc
rjmp wait


reset_adc:
ldi R16,0b11000101 ; Enable, no-interrupt, prescaling: 1:32
sts ADCSRA,R16
rjmp meas

      
