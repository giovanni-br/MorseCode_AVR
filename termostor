;Projeto de Sistemas Embarcados - FIS01237
;Instituto de Fisica - UFRGS
;Prof. Milton A Tumelero
;
;Atividade 7: Uso de ADC - Verificar o n�vel de ru�do no ADC com diferentes PS.
;
;Nesta atividade, um sensor de temperatura tipo NTC-10K (resistivo) ser� utilizado
;para realizar uma medida da temperatura com o ATmega328p, para isso uma ponte resistiva com um
;resistor de referencia sera aplicado para estimar a temperatura. O programa deve ler o ADC e gerar uma
;compara��o com um com um valor de setpoint, se a temperatura estiver maior o setpoint, um led em uma porta digital deve acender.

.include m328Pdef.inc
.org 0x0000
rjmp	inicio		;vai para SR inicio

inicio:
ldi    R16,low(RAMEND)  ;configura SPL como final da memoria RAM
out    SPL,R16
ldi    R16,high(RAMEND)  ;configura SPH como final da memoria RAM
out    SPH,R16
ldi R31, 0x00
ldi R30, 0x00
call config_Y


rjmp   config_PIN

config_PIN: ; configura os pinos do adc e digital
ser r16
out DDRD, r16
out PORTD, r16
clr r16
out DDRC, r16

config_ADC: ; configura o adc para medir com 10 bits.
ldi r16,0b01_000_000    ; Vcc sem alinhamento no ADC0
sts ADMUX,r16
ldi R16,0b110_00_111    ;adc ligado,128
sts ADCSRA,R16
ldi R16,0b00000000    ;adc ligado, 128
sts ADCSRB,R16
ldi R16,0b00000001    ;desabilitar digita D0
sts DIDR0,r16


meas: ; realiza aquisi��o com ADC
lds   r18,ADCSRA
SBRS  R18,6
rjmp  read
rjmp meas


read:
inc R31
lds    R16, ADCL
lds    R17, ADCH
st    Y+,R17   ; Salva o High na primeira posição da memoria
st    Y+,R16   ; salva o low na segunda posição da memoria
;ldi R16,0b110_00_111    ;adc ligado,128
;sts ADCSRA,R16
call adc_reset
CPI R31,0x1f
brne meas
call config_Y
rjmp mean

mean: ; calcula uma m�dia m�vel com N medidas do adc.
inc R30  ;começa a leitura da memoria
ld    R18,Y+ ;no R18 esta o high
ld    R19,Y+ ;no R19 esta o low
add   R21,R19 ; soma a parte low e pega o carry
adc   R20,R18 ; soma a parte high no R20 considerando o carry da parte low
CPI R30,0x1f  ; confere se fez 32 medidas
breq divide
rjmp mean

divide:
clc
ROL R20 ;rota primeiro a parte High para considerar o carry na parte low
ROL R21
clc
ROL R20
ROL R21
clc
ROL R20
ROL R21
clc
ROL R20
ROL R21
clc
ROL R20
ROL R21
rjmp compare_high

compare_high: ; compara o valor da m�dia com o setpoint
subi  R20,0x02
brpl  led
subi  R20,0x02; conferir
breq  compare_low

compare_low:
subi  R21,0Xaa
brpl  led
rjmp   inicio


adc_reset:
ldi R16,0b110_00_111    ;adc ligado, autotrigger, 128
sts ADCSRA,R16
ret


led: ; atualiza o valor do led a leitura do adc.
ldi  r16,0x00
out  PORTD,R16
rjmp inicio


config_Y:  ; Configura o apontador de mem�ria Y em 0x1000
ldi    YL,0x00
ldi    YH,0x01
ret

